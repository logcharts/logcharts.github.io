<!DOCTYPE html>
<html>
<style>
    html,body{
        height: 100%;
    }
    #rawDataWindow {
        position: absolute;
        top: 5%;
        left: 5%;
        width: 60%;
        max-width: 90%;
        height: 40%;
        max-width: 90%;
        border: black 1px solid;
        z-index: 100000;
        padding: 5px 10px 40px 5px;
        background: whitesmoke;
    }
    #rawDataInput {
        width: 100%;
        height: 100%;
    }
    #background{
        width: 100%;
        height: 100%;
        position: absolute;
    }
    /* Border styles */
    #pointCutTable thead, #pointCutTable tr {
        border-top-width: 1px;
        border-top-style: solid;
        border-top-color: #a8bfde;
    }
    #pointCutTable {
        border-bottom-width: 1px;
        border-bottom-style: solid;
        border-bottom-color: #a8bfde;
    }

    /* Padding and font style */
    #pointCutTable td, #pointCutTable th {
        padding: 5px 10px;
        font-size: 12px;
        font-family: Verdana;
        color: #5b7da3;
    }

    /* Alternating background colors */
    #pointCutTable tr:nth-child(even) {
        background: #d3dfed
    }
    #pointCutTable tr:nth-child(odd) {
        background: #FFF
    }
</style>
<head>
    <meta charset="utf-8">
    <title>日志图标</title>
    <!-- 引入 echarts.js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.1.2/echarts.common.min.js"></script>
    <script src="https://cdn.staticfile.org/angular.js/1.4.6/angular.min.js"></script>
</head>
<body>
<div ng-app="myApp" ng-controller="myCtrl">
<div id="background" ng-click="importCancel()">

<button ng-click="openImportWindow()">导入导出</button>
<div id="rawDataWindow" ng-show="rawDataWindowShow" onclick="event.stopPropagation()">
    <textarea id="rawDataInput" ng-model="rawData"></textarea>
    <button ng-click="importCopy()">复制</button>
    <button ng-click="importConfirm()">导入</button>
    <button ng-click="importCancel()">取消</button>
</div>

<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="logPointCutPercent" style="width: 1000px;height:400px;"></div>
    <div id="logLevelPercent" style="width: 1000px;height:400px;"></div>
    <div id="hourBar" style="width: 1000px;height:400px;"></div>
    <div id="pointCutTable">
        <p>日志入口统计详细: </p>
        <table>
            <thead>
            <tr>
                <td>入口位置</td>
                <td>日志大小</td>
                <td>输出行数</td>
                <td>触发次数</td>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="x in pointCutData">
                <td>{{ x.title }}</td>
                <td>{{ x.charCount }}</td>
                <td>{{ x.lineCount }}</td>
                <td>{{ x.times }}</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</div>
</body>
</html>
<script type="text/javascript">
    function getPercentData(data){
        let result = [];
        // 原始数据处理,只显示前7 和 其他的和
        let sortedKeys = Object.keys(data).sort((a, b) => {
            return data[b].charCount - data[a].charCount;
        });
        let othersCharCountSum = 0;
        for(var i=0;i<sortedKeys.length;i++){
            let key = sortedKeys[i];
            if (i<8){
                result.push({value: data[key].charCount, name: key});
            }
            else {
                othersCharCountSum += data[key].charCount;
            }
        }
        if(othersCharCountSum > 0){
            result.push({value: othersCharCountSum, name: '其他'});
        }
        return result;
    };
    function getSortedData(data){
        let result = [];
        // 原始数据处理,只显示前7 和 其他的和
        let sortedKeys = Object.keys(data).sort((a, b) => {
            return data[b].charCount - data[a].charCount;
        });
        for(var i=0;i<sortedKeys.length;i++){
            let key = sortedKeys[i];
            let thisData = data[key];
            thisData.title = key;
            result.push(thisData);
        }
        return result;
    };
    // 日志入口占比
    function setUpCharts() {
        echarts.init(document.getElementById('logPointCutPercent')).setOption(getPercentOption('日志入口占比', '日志大小', getPercentData(rawData.pointCutTable)));
        echarts.init(document.getElementById('logLevelPercent')).setOption(getPercentOption('日志级别占比', '日志大小', getPercentData(rawData.logLevelData)));

        echarts.init(document.getElementById('hourBar')).setOption(getBarOption('小时统计', rawData.hourData));
    };

    var rawData = {"hourData": {"2021-07-01 16": {"charCount": 77377778, "lineCount": 583854, "times": 13569}, "2021-07-01 15": {"charCount": 137297588, "lineCount": 1036883, "times": 22987}}, "basicInfo": {"fileModifyTime": "2021-07-01 16:31:27", "fileCreateTime": "2021-07-01 16:31:27", "fileSize": "204.73 MB", "fileName": "module-hrs-register-web.log"}, "logLevelData": {"INFO": {"charCount": 8742088, "lineCount": 25652, "times": 23596}, "WARN": {"charCount": 1643003, "lineCount": 2755, "times": 2755}, "ERROR": {"charCount": 204290275, "lineCount": 1592330, "times": 10205}}, "pointCutTable": {"c.g.m.h.b.c.m.h.s.i.ShiftCaseManagerImpl.listShiftCases:(103)": {"charCount": 305380, "lineCount": 536, "times": 536}, "c.g.m.h.b.c.m.h.o.i.OrderManagerImpl.order:(129)": {"charCount": 29329, "lineCount": 103, "times": 103}, "c.g.m.h.b.c.m.u.impl.UserManagerImpl.verifyTokenAndGetInfo:(62)": {"charCount": 523, "lineCount": 1, "times": 1}, "c.g.m.h.w.c.o.o.OrderInfoProcess.convertOrderDetail:(704)": {"charCount": 702, "lineCount": 3, "times": 3}, "c.g.m.h.b.c.m.h.s.i.ShiftCaseManagerImpl.listShiftCasesForStd:(67)": {"charCount": 520, "lineCount": 1, "times": 1}, "c.g.m.h.w.c.o.o.OrderConfigController.checkBeforeOrder:(707)": {"charCount": 755110, "lineCount": 2170, "times": 2170}, "o.s.boot.web.support.ErrorPageFilter.handleCommittedResponse:(225)": {"charCount": 10340, "lineCount": 22, "times": 22}, "akka.remote.Remoting.apply$mcV$sp:(75)": {"charCount": 758, "lineCount": 2, "times": 2}, "c.g.m.h.b.c.m.h.o.i.OrderManagerImpl.deleteOrdersByOrderId:(157)": {"charCount": 3279, "lineCount": 11, "times": 11}, "c.g.m.h.b.c.m.h.s.i.ShiftCaseManagerImpl.getShiftCase:(131)": {"charCount": 58242, "lineCount": 172, "times": 172}, "c.g.m.h.b.c.m.h.e.u.ExtUserResponseUtil.convertResponseDO:(42)": {"charCount": 102226, "lineCount": 264, "times": 264}, "c.g.g.a.p.t.a.i.BizParamInterceptor.printLog:(153)": {"charCount": 2694, "lineCount": 6, "times": 6}, "c.w.f.m.h.c.i.HttpMethodManagerImpl.getPostMethod:(40)": {"charCount": 3529636, "lineCount": 17826, "times": 17826}, "c.g.m.h.b.c.m.h.o.i.OrderManagerImpl.cancelOrder:(220)": {"charCount": 2155, "lineCount": 8, "times": 8}, "c.g.m.h.w.c.o.s.SubmitOrderProcess.placeAnOrder:(530)": {"charCount": 16195, "lineCount": 79, "times": 79}, "akka.remote.Remoting.apply$mcV$sp:(69)": {"charCount": 2308, "lineCount": 28, "times": 2}, "c.g.m.h.b.c.m.u.p.i.PatientManagerImpl.getUserPatientCart:(116)": {"charCount": 319660, "lineCount": 1453, "times": 1453}, "c.g.hrs.biz.dubbo.asp.HrsHeadAspect.dubboContext:(97)": {"charCount": 1151819, "lineCount": 2325, "times": 2325}, "c.n.d.s.r.aws.ConfigClusterResolver.getClusterEndpoints:(43)": {"charCount": 2822, "lineCount": 17, "times": 17}, "c.g.m.h.w.c.cookie.CookieProcess.getUnionId:(60)": {"charCount": 22533, "lineCount": 111, "times": 111}, "c.g.m.h.b.c.m.h.o.i.OrderManagerImpl.achieveVerifyCode:(498)": {"charCount": 5695, "lineCount": 11, "times": 11}, "c.g.m.h.w.c.o.o.OrderConfigController.checkBeforeOrder:(706)": {"charCount": 1815339, "lineCount": 2170, "times": 2170}, "c.g.m.h.b.c.m.h.o.i.OrderManagerImpl.cancelOrder:(221)": {"charCount": 2152, "lineCount": 8, "times": 8}, "c.g.m.h.b.c.m.s.w.i.WeDoctorSearchManagerImpl.listWeDoctorUserInfoForPageQuery:(47)": {"charCount": 3631, "lineCount": 9, "times": 9}, "c.w.f.m.logging.ModuleLoggingImpl.writeExceptionByError:(77)": {"charCount": 2777892, "lineCount": 26948, "times": 223}, "c.g.m.h.b.c.m.h.e.i.ExtProcessRuleManagerImpl.getExtUserRule:(46)": {"charCount": 17396, "lineCount": 44, "times": 44}, "unknown:None": {"charCount": 0, "lineCount": 0, "times": 0}, "c.g.m.h.b.c.m.c.HrsOrderStatusConsume.sendCoupon:(129)": {"charCount": 24536, "lineCount": 63, "times": 63}, "c.g.d.c.cluster.DitingTagInvoker.invoke$original$2eHCwhWc:(108)": {"charCount": 135103698, "lineCount": 1050624, "times": 4649}, "c.g.m.h.w.c.o.s.SubmitOrderProcess.checkBeforeSubmit:(228)": {"charCount": 2268249, "lineCount": 668, "times": 668}, "c.w.f.m.logging.ModuleLoggingImpl.writeExceptionByInfo:(64)": {"charCount": 218481, "lineCount": 2078, "times": 22}, "c.g.m.h.b.c.m.h.d.i.DepartmentManagerImpl.getHospDeptPlatformSpecialInfo:(40)": {"charCount": 5109, "lineCount": 17, "times": 17}, "c.g.m.h.b.c.m.h.o.i.OrderManagerImpl.order:(118)": {"charCount": 61865, "lineCount": 470, "times": 2}, "c.g.m.h.b.c.m.p.i.UserExtSafeManagerImpl.findByExtUserIdAndExtAppId:(42)": {"charCount": 76532, "lineCount": 111, "times": 111}, "c.g.m.h.b.c.m.u.impl.UserManagerImpl.listStatusByUserIds:(124)": {"charCount": 419396, "lineCount": 55, "times": 55}, "c.g.m.h.b.c.m.s.s.i.CommerceRecSearchMangerImpl.parseResultJsons:(114)": {"charCount": 2324, "lineCount": 6, "times": 6}, "c.g.m.h.b.c.m.c.HrsOrderStatusConsume.doConsumeMessage:(85)": {"charCount": 486795, "lineCount": 419, "times": 419}, "c.g.m.h.b.c.m.w.i.WeDoctorManagerImpl.listDoctorInfoBySearch:(146)": {"charCount": 2025, "lineCount": 9, "times": 9}, "RocketmqRemoting.info:(95)": {"charCount": 1110, "lineCount": 7, "times": 7}, "c.g.m.h.w.c.o.s.SubmitOrderProcess.placeAnOrder:(494)": {"charCount": 131227, "lineCount": 627, "times": 627}, "c.w.f.m.l.dubbo.DubboLoggingFilter.invoke:(69)": {"charCount": 64935683, "lineCount": 511255, "times": 2324}}}
    function getPercentOption(chartName, dataName, data){
        return {
            title: {
                text: chartName,
                subtext: '',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                position:function(position){
                    //获取容器的宽度
                    // var chartsWidth = $("#threadtrend").width();
                    // //判断悬停点落在容器的哪测
                    // if(position[0] < (chartsWidth/2)){
                    //     position[0] = position[0];
                    // }else{
                    //     position[0] = position[0] - 130;
                    // }
                    return [position[0], position[1]];
                },
            },
            series: [
                {
                    name: dataName,
                    type: 'pie',
                    radius: [20, 90],
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    label: {
                        alignTo: 'edge',
                        formatter: '{name|{b}}\n{time|{c} ({d}%)}',
                        minMargin: 5,
                        edgeDistance: 10,
                        lineHeight: 15,
                        rich: {
                            time: {
                                fontSize: 10,
                                color: '#999'
                            }
                        }
                    },
                    labelLine: {
                        length: 15,
                        length2: 0,
                        maxSurfaceAngle: 80
                    },
                    labelLayout: function (params) {
                        var isLeft = params.labelRect.x < 500;
                        var points = params.labelLinePoints;
                        // Update the end point.
                        points[2][0] = isLeft
                            ? params.labelRect.x
                            : params.labelRect.x + params.labelRect.width;

                        return {
                            labelLinePoints: points
                        };
                    },
                    data: data
                }
            ]
        };
    }

    function getBarOption(chartName,data){

        let result = [];
        // 原始数据处理,只显示前7 和 其他的和
        let sortedKeys = Object.keys(data).sort();
        let values = sortedKeys.map(key => data[key].charCount);


        return {
            title: {
                text: chartName,
                subtext: '',
                left: 'center'
            },
            tooltip: {
                trigger: 'item'
            },
            xAxis: {
                type: 'category',
                data: sortedKeys
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                data: values,
                type: 'bar'
            }]
        };
    }

    setUpCharts();


    var app = angular.module('myApp', []);
    app.controller('myCtrl', function($scope) {

        $scope.init = function() {
            $scope.rawDataWindowShow = false;
            $scope.pointCutData = getSortedData(rawData.pointCutData);
            setUpCharts();
        };
        $scope.init();


        $scope.openImportWindow = function() {
            $scope.rawData = JSON.stringify(rawData);
            $scope.rawDataWindowShow = true;
            event.stopPropagation( );
            return false;
        };
        $scope.importCopy = function() {
            var input = document.getElementById("rawDataInput");
            input.select(); // 选中文本
            document.execCommand("copy");
            alert("复制成功");
        };
        $scope.importConfirm = function() {
            rawData = JSON.parse($scope.rawData);
            $scope.init();

        };
        $scope.importCancel = function() {
            $scope.rawDataWindowShow = false;
        };


    });
</script>